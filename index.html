<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>AR Info Panel</title>
    <script>
        // Prevent popup.js error
        window.myObject = {
            create: function() {
                return true;
            }
        };

        // Suppress WebGL warnings
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;

        console.warn = function() {
            if (arguments[0] && (
                arguments[0].includes('WebGL') ||
                arguments[0].includes('GL_INVALID') ||
                arguments[0].includes('texSubImage2D')
            )) {
                return;
            }
            originalConsoleWarn.apply(console, arguments);
        };

        console.error = function() {
            if (arguments[0] && arguments[0].includes('popup.js')) {
                return;
            }
            originalConsoleError.apply(console, arguments);
        };
    </script>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script>
        function showInfoPanel(infoId, soundId) {
            console.log('showInfoPanel called with:', infoId, soundId); // DEBUGGING LINE

            // Hide all panels and stop all sounds
            for (let i = 1; i <= 4; i++) {
                const panel = document.querySelector(`#infoPanel${i}`);
                const sound = document.querySelector(`#infoSound${i}`);
                if (panel) panel.setAttribute('visible', false);
                if (sound) {
                    sound.pause();
                    sound.currentTime = 0;
                }
            }

            // Show selected panel and play selected sound
            const selectedPanel = document.querySelector(`#${infoId}`);
            const selectedSound = document.querySelector(`#${soundId}`);
            if (selectedPanel) selectedPanel.setAttribute('visible', true);
            if (selectedSound) selectedSound.play();
        }

        AFRAME.registerComponent('info-button-listener', {
            init: function () {
                const buttonNumber = this.el.id.slice(-1); // Get the number from the button ID
                const infoPanelId = `infoPanel${buttonNumber}`;
                const infoSoundId = `infoSound${buttonNumber}`;
                const self = this;

                this.el.addEventListener('click', function () {
                    console.log('Button', buttonNumber, 'clicked'); // Debugging
                    showInfoPanel(infoPanelId, infoSoundId);
                });
            }
        });

        // Register random fly animation
        AFRAME.registerComponent('random-fly', {
            schema: {
                speed: { type: 'number', default: 3000 }
            },
            init: function () {
                this.startRandomAnimation();
            },
            startRandomAnimation: function () {
                const el = this.el;
                const speed = this.data.speed;

                function setRandomPosition() {
                    const x = (Math.random() - 0.5) * 4;
                    const y = 0.2 + Math.random() * 1.8;
                    const z = -2.8 + Math.random() * 0.4;

                    el.setAttribute('animation__move', {
                        property: 'position',
                        to: `${x} ${y} ${z}`,
                        dur: speed,
                        easing: 'easeInOutSine',
                        loop: false
                    });
                }

                setInterval(setRandomPosition, speed);
                setRandomPosition();
            }
        });

        // Create multiple flying effects when scene loads
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.querySelector('a-scene');
            const flyingEffectsContainer = document.querySelector('#flyingEffects');
            const flyingEffectTemplate = document.querySelector('#flyingEffectTemplate');

            scene.addEventListener('loaded', () => {
                for (let i = 0; i < 20; i++) {
                    const fx = flyingEffectTemplate.cloneNode(true);
                    fx.setAttribute('id', `flyingEffect${i}`);
                    fx.setAttribute('visible', true);

                    const x = (Math.random() - 0.5) * 2;    // Adjust range for AR
                    const y = 0.1 + Math.random() * 1;      // Adjust range for AR
                    const z = -0.8 + Math.random() * 0.2;    // Adjust Z position for AR

                    fx.setAttribute('position', `${x} ${y} ${z}`);
                    flyingEffectsContainer.appendChild(fx);
                }
            });
        });
    </script>
</head>
<body>
    <a-scene
    renderer="antialias: true; colorManagement: true;"
    loading-screen="enabled: true"
    vr-mode-ui="enabled: false"
    arjs="detectionMode: mono_and_matrix; debugUIEnabled: true; sourceType: webcam; patternRatio: 0.5">

    <a-assets timeout="10000">
        <img id="testImage" src="https://via.placeholder.com/50" crossorigin="anonymous">
    </a-assets>

    <a-camera position="0 0 0" look-controls-enabled="false" arjs-look-controls="smoothingThreshold: 0.2;"></a-camera>

    <a-box position="0 0 -1" color="red"></a-box>

    <a-image
        id="testPanel"
        src="#testImage"
        position="0 0 -0.5"
        width="0.2"
        height="0.2"
        material="shader: flat; transparent: true; opacity: 1">
    </a-image>

    <a-entity id="imageContainer" position="0 0 -1.2">
        </a-entity>

    <a-entity id="flyingEffects">
        </a-entity>

    </a-scene>

    <script>
        // Modify the flying effect creation for AR
        document.addEventListener('DOMContentLoaded', () => {
            const scene = document.querySelector('a-scene');
            const flyingEffectsContainer = document.querySelector('#flyingEffects');
            const flyingEffectTemplate = document.querySelector('#flyingEffectTemplate');

            scene.addEventListener('loaded', () => {
                for (let i = 0; i < 20; i++) {
                    const fx = flyingEffectTemplate.cloneNode(true);
                    fx.setAttribute('id', `flyingEffect${i}`);
                    fx.setAttribute('visible', true);

                    const x = (Math.random() - 0.5) * 2;    // Adjust range for AR
                    const y = 0.1 + Math.random() * 1;      // Adjust range for AR
                    const z = -0.8 + Math.random() * 0.2;    // Adjust Z position for AR

                    fx.setAttribute('position', `${x} ${y} ${z}`);
                    flyingEffectsContainer.appendChild(fx);
                }
            });
        });
    </script>
</body>
</html>