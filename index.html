<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Info Panel with Marker Tracking</title>

    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        /* Basic styling for the body */
        body {
            margin: 0;
            overflow: hidden; /* Hide scrollbars */
        }

        /* Style the A-Frame loading screen */
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #loading-screen.hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <p>Loading AR experience...</p>
    </div>

    <a-scene
        renderer="antialias: true; colorManagement: true;"
        loading-screen="enabled: true"
        vr-mode-ui="enabled: false"
        arjs="detectionMode: mono_and_matrix; sourceType: webcam; patternRatio: 0.5; debugUIEnabled: false;">

        <a-assets timeout="10000">
            <img id="img1"
                 src="https://placehold.co/800x500/cccccc/000000?text=Base+Image"
                 crossorigin="anonymous"
                 onerror="this.onerror=null; console.error('Error loading image:', this.src);">

            <img id="infoSvg1"
                 src="https://placehold.co/400x500/ff0000/ffffff?text=Info+Panel+1"
                 crossorigin="anonymous"
                 onerror="this.onerror=null; console.error('Error loading image:', this.src);">
            <img id="infoSvg2"
                 src="https://placehold.co/400x500/00ff00/ffffff?text=Info+Panel+2"
                 crossorigin="anonymous"
                 onerror="this.onerror=null; console.error('Error loading image:', this.src);">
            <img id="infoSvg3"
                 src="https://placehold.co/400x500/0000ff/ffffff?text=Info+Panel+3"
                 crossorigin="anonymous"
                 onerror="this.onerror=null; console.error('Error loading image:', this.src);">
            <img id="infoSvg4"
                 src="https://placehold.co/400x500/ffff00/000000?text=Info+Panel+4"
                 crossorigin="anonymous"
                 onerror="this.onerror=null; console.error('Error loading image:', this.src);">

            <img id="infobutton1"
                 src="https://placehold.co/100x100/007bff/ffffff?text=Btn1"
                 crossorigin="anonymous"
                 onerror="this.onerror=null; console.error('Error loading image:', this.src);">
            <img id="infobutton2"
                 src="https://placehold.co/100x100/007bff/ffffff?text=Btn2"
                 crossorigin="anonymous"
                 onerror="this.onerror=null; console.error('Error loading image:', this.src);">
            <img id="infobutton3"
                 src="https://placehold.co/100x100/007bff/ffffff?text=Btn3"
                 crossorigin="anonymous"
                 onerror="this.onerror=null; console.error('Error loading image:', this.src);">
            <img id="infobutton4"
                 src="https://placehold.co/100x100/007bff/ffffff?text=Btn4"
                 crossorigin="anonymous"
                 onerror="this.onerror=null; console.error('Error loading image:', this.src);">

            <img id="flyingEffect"
                 src="https://placehold.co/75x75/800080/ffffff?text=FX"
                 crossorigin="anonymous"
                 onerror="this.onerror=null; console.error('Error loading image:', this.src);">

            <audio id="infoSound1"
                   src="https://file-examples.com/storage/fe103015080c03a35a54c46/2017/11/file_example_WAV_1MG.wav"
                   preload="auto"
                   onerror="this.onerror=null; console.error('Error loading audio:', this.src);"></audio>
            <audio id="infoSound2"
                   src="https://file-examples.com/storage/fe103015080c03a35a54c46/2017/11/file_example_WAV_2MG.wav"
                   preload="auto"
                   onerror="this.onerror=null; console.error('Error loading audio:', this.src);"></audio>
            <audio id="infoSound3"
                   src="https://file-examples.com/storage/fe103015080c03a35a54c46/2017/11/file_example_WAV_5MG.wav"
                   preload="auto"
                   onerror="this.onerror=null; console.error('Error loading audio:', this.src);"></audio>
            <audio id="infoSound4"
                   src="https://file-examples.com/storage/fe103015080c03a35a54c46/2017/11/file_example_WAV_1MG.wav"
                   preload="auto"
                   onerror="this.onerror=null; console.error('Error loading audio:', this.src);"></audio>
        </a-assets>

        <a-camera position="0 0 0" look-controls-enabled="false" arjs-look-controls></a-camera>

        <a-marker type='pattern' url='https://raw.githubusercontent.com/AR-js-org/AR.js/master/aframe/build/examples/pattern-files/pattern-hiro.patt'>

            <a-image
                id="baseImage"
                src="#img1"
                width="2" height="1.25"
                position="0 0 0"  material="shader: flat; npot: true; transparent: true">
            </a-image>

            <a-entity id="infoButton1" data-infopanel="infoPanel1" data-infosound="infoSound1" class="info-button"
                      position="-0.6 0.01 0.01" info-button-listener> <a-image src="#infobutton1" width="0.1" height="0.1" class="clickable"
                         position="0 0 0"> </a-image>
                <a-image id="infoPanel1" src="#infoSvg1"
                         position="-0.3 0.3 0.02"  width="0.4" height="0.5"
                         material="shader: flat; npot: true; transparent: true; opacity: 0"
                         visible="false">
                </a-image>
            </a-entity>

            <a-entity id="infoButton2" data-infopanel="infoPanel2" data-infosound="infoSound2" class="info-button"
                      position="-0.4 -0.2 0.01" info-button-listener> <a-image src="#infobutton2" width="0.1" height="0.1" class="clickable"
                         position="0 0 0"> </a-image>
                 <a-image id="infoPanel2" src="#infoSvg2"
                         position="-0.2 0.3 0.02"  width="0.4" height="0.5"
                         material="shader: flat; npot: true; transparent: true; opacity: 0"
                         visible="false">
                </a-image>
            </a-entity>

            <a-entity id="infoButton3" data-infopanel="infoPanel3" data-infosound="infoSound3" class="info-button"
                      position="0.6 0.0141 0.01" info-button-listener> <a-image src="#infobutton3" width="0.1" height="0.1" class="clickable"
                         position="0 0 0"> </a-image>
                 <a-image id="infoPanel3" src="#infoSvg3"
                         position="-0.3 0.3 0.02"  width="0.4" height="0.5"
                         material="shader: flat; npot: true; transparent: true; opacity: 0"
                         visible="false">
                </a-image>
            </a-entity>

            <a-entity id="infoButton4" data-infopanel="infoPanel4" data-infosound="infoSound4" class="info-button"
                      position="0.2 0.0141 0.01" info-button-listener> <a-image src="#infobutton4" width="0.1" height="0.1" class="clickable"
                         position="0 0 0"> </a-image>
                 <a-image id="infoPanel4" src="#infoSvg4"
                         position="-0.2 0.3 0.02"  width="0.4" height="0.5"
                         material="shader: flat; npot: true; transparent: true; opacity: 0"
                         visible="false">
                </a-image>
            </a-entity>

             <a-entity id="flyingEffects">
                <a-image
                    id="flyingEffectTemplate"
                    src="#flyingEffect"
                    width="0.075"
                    height="0.075"
                    material="transparent: true; opacity: 0.8; shader: flat; npot: true"
                    random-fly=""
                    visible="false">
                </a-image>
            </a-entity>

        </a-marker>

        </a-scene>

    <script>
        // A-Frame Component to handle info button clicks
        AFRAME.registerComponent('info-button-listener', {
            init: function () {
                const el = this.el; // The entity this component is attached to (e.g., infoButton1)
                const panelId = el.getAttribute('data-infopanel'); // Get the ID of the linked info panel
                const soundId = el.getAttribute('data-infosound'); // Get the ID of the linked audio
                const panelEl = document.getElementById(panelId); // Get the info panel element
                const soundEl = document.getElementById(soundId); // Get the audio element

                // Basic error checking to ensure linked elements exist
                if (!panelEl) {
                    console.error(`Info panel with ID ${panelId} not found for entity ${el.id}!`);
                    return;
                }
                // Audio is optional, so log a warning instead of error if not found
                if (!soundEl) {
                    console.warn(`Info sound with ID ${soundId} not found for entity ${el.id}. Audio playback will be skipped.`);
                }

                // Add click listener to the entity (or a child element if needed)
                // We'll attach it to the parent entity for simplicity here
                el.addEventListener('click', () => {
                    this.showInfo(panelEl, soundEl);
                });
            },

            // Function to show the selected info panel and play audio
            showInfo: function (panelEl, soundEl) {
                // Hide all other info panels and stop all sounds
                const allInfoPanels = document.querySelectorAll('[id^="infoPanel"]');
                const allInfoSounds = document.querySelectorAll('audio[id^="infoSound"]');

                allInfoPanels.forEach(p => {
                    // Use A-Frame's setAttribute for visibility and material properties
                    p.setAttribute('visible', false);
                    p.setAttribute('material', 'opacity: 0');
                });

                allInfoSounds.forEach(s => {
                    s.pause();
                    s.currentTime = 0; // Rewind audio
                });

                // Show the selected panel and make it fully opaque
                panelEl.setAttribute('visible', true);
                panelEl.setAttribute('material', 'opacity: 1');

                // Play the selected sound if it exists
                if (soundEl) {
                    soundEl.play().catch(error => {
                         console.error("Audio playback failed:", error);
                    });
                }
            }
        });

        // A-Frame Component for random flying animation
        AFRAME.registerComponent('random-fly', {
            schema: {
                speed: { type: 'number', default: 3000 }, // Animation duration in milliseconds
                area: { type: 'vec3', default: {x: 1, y: 1, z: 0.5} } // Define the random movement area (relative to parent)
            },

            init: function () {
                this.startRandomAnimation();
            },

            // Function to set a new random position and start animation
            startRandomAnimation: function () {
                const el = this.el; // The flying effect entity
                const speed = this.data.speed;
                const area = this.data.area;

                // Generate random position within the defined area
                // Positions are relative to the parent entity (the marker in this case)
                const x = (Math.random() - 0.5) * area.x;
                const y = (Math.random() - 0.5) * area.y;
                const z = (Math.random() - 0.5) * area.z;

                // Set up and start the animation
                el.setAttribute('animation__move', {
                    property: 'position',
                    to: `${x} ${y} ${z}`,
                    dur: speed,
                    easing: 'easeInOutSine',
                    loop: false // Animation runs once per interval
                });

                // Listen for animation completion to start the next one
                el.addEventListener('animation__move-end', () => {
                    this.startRandomAnimation(); // Start a new animation when the current one ends
                });
            }
        });

        // JavaScript to instantiate multiple flying effects after the scene is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const sceneEl = document.querySelector('a-scene');

            // Wait for the A-Frame scene to be fully loaded
            sceneEl.addEventListener('loaded', () => {
                const flyingEffectsContainer = document.querySelector('#flyingEffects');
                const flyingEffectTemplate = document.querySelector('#flyingEffectTemplate');

                // Create 20 instances of the flying effect template
                for (let i = 0; i < 20; i++) {
                    const fx = flyingEffectTemplate.cloneNode(true); // Clone the template
                    fx.setAttribute('id', `flyingEffect${i}`); // Give it a unique ID
                    fx.setAttribute('visible', true); // Make it visible

                    // Set an initial random position within the defined area
                    const area = flyingEffectTemplate.getAttribute('random-fly').area || {x: 1, y: 1, z: 0.5}; // Get area from component schema or default
                    const x = (Math.random() - 0.5) * area.x;
                    const y = (Math.random() - 0.5) * area.y;
                    const z = (Math.random() - 0.5) * area.z;
                    fx.setAttribute('position', `${x} ${y} ${z}`);

                    flyingEffectsContainer.appendChild(fx); // Add the cloned entity to the container
                }

                // Hide the loading screen once the scene is ready
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
